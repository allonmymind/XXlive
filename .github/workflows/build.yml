name: Android Build for All Branches

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'è¦æ„å»ºçš„åˆ†æ”¯'
        required: true
        default: 'kitkat'
        type: choice
        options:
          - kitkat
          - main
          - develop

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºæŒ‡å®šåˆ†æ”¯çš„ä»£ç 
      - name: Checkout selected branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0

      # 2. è®¾ç½®ç¯å¢ƒ
      - name: Setup Java & Android
        uses: android-actions/setup-android@v3

      # 3. æ ¹æ®åˆ†æ”¯è¿›è¡Œä¸åŒé…ç½®
      - name: Configure for branch
        run: |
          echo "ğŸ”§ é…ç½®åˆ†æ”¯: ${{ inputs.target_branch }}"
          
          if [ "${{ inputs.target_branch }}" = "kitkat" ]; then
            echo "ğŸ¯ è¿™æ˜¯ Android 4.4 å…¼å®¹åˆ†æ”¯"
            # æ·»åŠ  Android 4.4 ç‰¹å®šé…ç½®
            echo "android.defaults.buildtools.version=30.0.3" >> gradle.properties
            echo "android.defaults.compileSdk=19" >> gradle.properties
          else
            echo "ğŸ“± è¿™æ˜¯æ ‡å‡†åˆ†æ”¯"
          fi
          
          # ç¦ç”¨ Gradle è‡ªåŠ¨ç­¾å
          echo "# å¼ºåˆ¶ç¦ç”¨è‡ªåŠ¨ç­¾å" > gradle.properties
          echo "android.injected.signing.store.file=/dev/null" >> gradle.properties
          echo "android.injected.signing.store.password=none" >> gradle.properties
          echo "android.injected.signing.key.alias=none" >> gradle.properties
          echo "android.injected.signing.key.password=none" >> gradle.properties

      # 4. æ„å»ºæœªç­¾åAPK
      - name: Build UNSIGNED APK
        run: |
          chmod +x gradlew
          echo "ğŸ—ï¸ æ„å»ºæœªç­¾åAPK..."
          
          ./gradlew clean
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=/dev/null \
            -Pandroid.injected.signing.store.password=none \
            -Pandroid.injected.signing.key.alias=none \
            -Pandroid.injected.signing.key.password=none
          
          echo "âœ… ç”Ÿæˆçš„APKæ–‡ä»¶ï¼š"
          find app/build/outputs/apk -name "*.apk" -type f | xargs ls -la

      # 5. æ‰‹åŠ¨ç­¾åï¼ˆä½¿ç”¨ä½ çš„ç»Ÿä¸€keystoreï¼‰
      - name: Sign APK Manually
        id: sign_apk
        env:
          KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE }}
        run: |
          echo "ğŸ” å¼€å§‹æ‰‹åŠ¨ç­¾å..."
          
          # è§£ç keystore
          echo "$KEYSTORE_BASE64" | base64 --decode > myapp.keystore
          
          # æŸ¥æ‰¾APK
          UNSIGNED_APK=$(find app/build/outputs/apk -name "*unsigned*.apk" -o -name "app-release.apk" | head -1)
          
          # å¯¹é½
          ALIGNED_APK="${UNSIGNED_APK%.apk}-aligned.apk"
          $ANDROID_HOME/build-tools/34.0.0/zipalign -v -p 4 "$UNSIGNED_APK" "$ALIGNED_APK"
          
          # ç­¾å
          SIGNED_APK="app/build/outputs/apk/release/app-release-signed.apk"
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks myapp.keystore \
            --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --v1-signing-enabled true \
            --v2-signing-enabled true \
            --out "$SIGNED_APK" \
            "$ALIGNED_APK"
          
          echo "signedReleaseFile=$SIGNED_APK" >> $GITHUB_OUTPUT

      # 6. åˆ›å»ºå‘å¸ƒ
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "build-${{ github.run_id }}-${{ inputs.target_branch }}"
          name: "Build from ${{ inputs.target_branch }}"
          body: |
            ğŸš€ **åˆ†æ”¯æ„å»º: ${{ inputs.target_branch }}**
            
            æ„å»ºID: ${{ github.run_id }}
            åˆ†æ”¯: ${{ inputs.target_branch }}
            æ—¶é—´: $(date)
            
            âœ… **æ”¯æŒè¦†ç›–å®‰è£…**
            âœ… **ä½¿ç”¨ç»Ÿä¸€ç­¾åå¯†é’¥**
            âœ… **Android 4.4+ å…¼å®¹**
          files: ${{ steps.sign_apk.outputs.signedReleaseFile }}
          draft: false
          prerelease: false
