name: Build with Manual Signing

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # ğŸ”¥ å…³é”®æ­¥éª¤ï¼šå¼ºåˆ¶ç¦ç”¨Gradleè‡ªåŠ¨ç­¾å
    - name: Disable Gradle auto-signing
      run: |
        echo "ğŸ›‘ ç¦ç”¨Gradleè‡ªåŠ¨ç­¾å..."
        
        # æ–¹æ³•1ï¼šä¿®æ”¹gradle.propertiesï¼ˆå…¨å±€ç”Ÿæ•ˆï¼‰
        echo "android.injected.signing.store.file=/dev/null" >> gradle.properties
        echo "android.injected.signing.store.password=disabled" >> gradle.properties
        echo "android.injected.signing.key.alias=disabled" >> gradle.properties
        echo "android.injected.signing.key.password=disabled" >> gradle.properties
        
        # æ–¹æ³•2ï¼šæ£€æŸ¥å¹¶ç§»é™¤app/build.gradleä¸­çš„ç­¾åé…ç½®
        if [ -f "app/build.gradle" ]; then
          echo "æ£€æŸ¥app/build.gradleä¸­çš„ç­¾åé…ç½®..."
          # ä¸´æ—¶æ³¨é‡Šæ‰signingConfigsé…ç½®
          sed -i 's/signingConfigs/# signingConfigs/g' app/build.gradle
          sed -i 's/signingConfig/# signingConfig/g' app/build.gradle
        fi

    - name: Build UNSIGNED APK
      run: |
        chmod +x gradlew
        echo "ğŸ—ï¸ æ„å»ºæœªç­¾åAPK..."
        
        # å¼ºåˆ¶æ„å»ºæœªç­¾åç‰ˆæœ¬
        ./gradlew clean
        
        # ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ç¡®ä¿ç”Ÿæˆæœªç­¾åAPK
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=/dev/null \
          -Pandroid.injected.signing.store.password=disabled \
          -Pandroid.injected.signing.key.alias=disabled \
          -Pandroid.injected.signing.key.password=disabled
        
        echo "âœ… æœªç­¾åAPKç”Ÿæˆå®Œæˆ"
        find app/build/outputs/apk -name "*unsigned*" -o -name "*release*.apk" | xargs ls -la

    # ğŸ” ä½¿ç”¨ä½ çš„ç»Ÿä¸€keystoreæ‰‹åŠ¨ç­¾å
    - name: Manual Signing with Your Keystore
      id: manual_sign
      env:
        KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE }}
      run: |
        echo "ğŸ” å¼€å§‹æ‰‹åŠ¨ç­¾å..."
        
        # 1. è§£ç keystore
        echo "$KEYSTORE_BASE64" | base64 --decode > my-release-key.keystore
        
        # 2. éªŒè¯keystore
        echo "ğŸ” éªŒè¯keystoreæ–‡ä»¶..."
        file my-release-key.keystore
        echo "æ–‡ä»¶å¤§å°: $(wc -c < my-release-key.keystore) bytes"
        
        # 3. æ£€æŸ¥æ˜¯å¦ä¸ºJKSæ ¼å¼ï¼Œå¦‚æœä¸æ˜¯åˆ™è½¬æ¢
        if ! file my-release-key.keystore | grep -q "Java KeyStore"; then
          echo "ğŸ”„ è½¬æ¢ä¸ºJKSæ ¼å¼..."
          keytool -importkeystore \
            -srckeystore my-release-key.keystore \
            -destkeystore my-release-key.jks \
            -deststoretype JKS \
            -srcstorepass "${{ secrets.KEYSTORE_PASSWORD }}" \
            -deststorepass "${{ secrets.KEYSTORE_PASSWORD }}" \
            -srcalias "${{ secrets.KEY_ALIAS }}" \
            -destalias "${{ secrets.KEY_ALIAS }}" \
            -noprompt 2>/dev/null || echo "è½¬æ¢å¯èƒ½å·²å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨"
          USE_KEYSTORE="my-release-key.jks"
        else
          USE_KEYSTORE="my-release-key.keystore"
        fi
        
        # 4. æŸ¥æ‰¾APKæ–‡ä»¶
        UNSIGNED_APK=$(find app/build/outputs/apk -name "*unsigned*.apk" -o -name "app-release.apk" | head -1)
        echo "ğŸ“¦ æ‰¾åˆ°APKæ–‡ä»¶: $UNSIGNED_APK"
        
        if [ ! -f "$UNSIGNED_APK" ]; then
          echo "âŒ æœªæ‰¾åˆ°APKæ–‡ä»¶!"
          find app/build/outputs/apk -type f -name "*.apk" | xargs ls -la
          exit 1
        fi
        
        # 5. å¯¹é½APK
        ALIGNED_APK="${UNSIGNED_APK%.apk}-aligned.apk"
        echo "ğŸ“ å¯¹é½APK: $ALIGNED_APK"
        
        $ANDROID_HOME/build-tools/34.0.0/zipalign -v -p 4 "$UNSIGNED_APK" "$ALIGNED_APK"
        
        # 6. ç­¾åAPK
        SIGNED_APK="app/build/outputs/apk/release/app-release-signed.apk"
        echo "ğŸ–Šï¸ ç­¾åAPK: $SIGNED_APK"
        
        $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
          --ks "$USE_KEYSTORE" \
          --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
          --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
          --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
          --v1-signing-enabled true \
          --v2-signing-enabled true \
          --out "$SIGNED_APK" \
          "$ALIGNED_APK"
        
        # 7. éªŒè¯ç­¾å
        echo "âœ… éªŒè¯ç­¾å..."
        $ANDROID_HOME/build-tools/34.0.0/apksigner verify --verbose "$SIGNED_APK"
        
        # 8. è¾“å‡ºæ–‡ä»¶è·¯å¾„
        echo "signedReleaseFile=$SIGNED_APK" >> $GITHUB_OUTPUT
        echo "ğŸ‰ ç­¾åå®Œæˆ!"
        
        # 9. æ˜¾ç¤ºè¯ä¹¦ä¿¡æ¯
        echo "ğŸ” APKè¯ä¹¦æŒ‡çº¹:"
        $ANDROID_HOME/build-tools/34.0.0/apksigner verify --print-certs "$SIGNED_APK" | grep -A5 "Signer"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: "æ‰‹åŠ¨ç­¾åç‰ˆæœ¬ ${{ github.ref_name }}"
        body: |
          ğŸ” **æ‰‹åŠ¨ç­¾åç‰ˆæœ¬**
          
          æ­¤ç‰ˆæœ¬ä½¿ç”¨ç»Ÿä¸€å‘å¸ƒå¯†é’¥æ‰‹åŠ¨ç­¾åï¼Œæ”¯æŒï¼š
          - âœ… è¦†ç›–å®‰è£…ï¼ˆæ— éœ€å¸è½½ï¼‰
          - âœ… Android 4.4+ å…¼å®¹
          - âœ… ç»Ÿä¸€çš„è¯ä¹¦æŒ‡çº¹
          
          ğŸ“± å®‰è£…è¯´æ˜ï¼š
          1. ç›´æ¥å®‰è£…å³å¯è¦†ç›–æ—§ç‰ˆæœ¬
          2. åº”ç”¨æ•°æ®å°†ä¿ç•™
          
          ğŸ”§ æŠ€æœ¯ä¿¡æ¯ï¼š
          - ç­¾åæ–¹å¼ï¼šæ‰‹åŠ¨ç­¾åï¼ˆç»•è¿‡Gradleè‡ªåŠ¨ç­¾åï¼‰
          - å¯†é’¥ç±»å‹ï¼šJKS
          - åŒ…å«V1ç­¾åï¼šæ˜¯ï¼ˆå…¼å®¹Android 4.4ï¼‰
        files: ${{ steps.manual_sign.outputs.signedReleaseFile }}
        draft: false
        prerelease: false
