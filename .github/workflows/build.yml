name: build-with-unified-signing

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Ê∏ÖÁêÜÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÁ≠æÂêçÈÖçÁΩÆ
        run: |
          echo "Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂..."
          rm -f app/release.keystore
          rm -f app/signingKey.jks
          
          # Ê£ÄÊü•GradleÈÖçÁΩÆ
          if grep -q "signingConfig" app/build.gradle; then
            echo "‚ö†Ô∏è ÂèëÁé∞GradleÁ≠æÂêçÈÖçÁΩÆÔºåÂª∫ËÆÆÁßªÈô§"
            grep -n "signingConfig" app/build.gradle
          fi

      - name: Build unsigned APK
        run: |
          chmod +x gradlew
          echo "ÊûÑÂª∫Êú™Á≠æÂêçÁöÑAPK..."
          ./gradlew clean
          ./gradlew assembleRelease -Pandroid.injected.signing.store.file=/dev/null
          
          # Á°ÆËÆ§ÁîüÊàê‰∫ÜÊú™Á≠æÂêçAPK
          echo "ÁîüÊàêÁöÑAPKÊñá‰ª∂Ôºö"
          find app/build/outputs/apk -name "*.apk" -type f | xargs ls -la

      - name: ‰ΩøÁî®Áªü‰∏ÄkeystoreÁ≠æÂêçAPK
        id: sign_apk
        env:
          KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE }}
        run: |
          echo "üéØ ÂºÄÂßãÁ≠æÂêçËøáÁ®ã..."
          
          # 1. Ëß£Á†Åkeystore
          echo "$KEYSTORE_BASE64" | base64 --decode > unified.keystore
          echo "‚úÖ KeystoreÊñá‰ª∂Â§ßÂ∞è: $(wc -c < unified.keystore) Â≠óËäÇ"
          
          # 2. È™åËØÅkeystoreÊ†ºÂºè
          echo "üîç Ê£ÄÊü•keystoreÁ±ªÂûã..."
          file unified.keystore
          
          # 3. ËΩ¨Êç¢keystoreÊ†ºÂºèÔºàÂ¶ÇÊûúÂøÖË¶ÅÔºâ
          echo "üîÑ Á°Æ‰øù‰ΩøÁî®JKSÊ†ºÂºè..."
          keytool -importkeystore \
            -srckeystore unified.keystore \
            -destkeystore final.keystore \
            -deststoretype JKS \
            -srcstorepass "${{ secrets.KEYSTORE_PASSWORD }}" \
            -deststorepass "${{ secrets.KEYSTORE_PASSWORD }}" \
            -srcalias "${{ secrets.KEY_ALIAS }}" \
            -destalias "${{ secrets.KEY_ALIAS }}" \
            -srckeypass "${{ secrets.KEY_PASSWORD }}" \
            -destkeypass "${{ secrets.KEY_PASSWORD }}" \
            -noprompt 2>/dev/null || echo "Â∑≤ÁªèÊòØJKSÊ†ºÂºè"
          
          # 4. ÂØπÈΩêAPK
          INPUT_APK="app/build/outputs/apk/release/app-release-unsigned.apk"
          ALIGNED_APK="app/build/outputs/apk/release/app-release-aligned.apk"
          
          echo "üìê ÂØπÈΩêAPK..."
          $ANDROID_HOME/build-tools/34.0.0/zipalign -v -p 4 "$INPUT_APK" "$ALIGNED_APK"
          
          # 5. Á≠æÂêçAPKÔºà‰ΩøÁî®JKSÊ†ºÂºèÔºâ
          SIGNED_APK="app/build/outputs/apk/release/app-release-signed.apk"
          
          echo "üñäÔ∏è Á≠æÂêçAPK..."
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks final.keystore \
            --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --v1-signing-enabled true \
            --v2-signing-enabled true \
            --out "$SIGNED_APK" \
            "$ALIGNED_APK"
          
          # 6. È™åËØÅÁ≠æÂêç
          echo "‚úÖ È™åËØÅÁ≠æÂêç..."
          $ANDROID_HOME/build-tools/34.0.0/apksigner verify --verbose "$SIGNED_APK"
          
          # 7. ËæìÂá∫ÁªìÊûú
          echo "signedReleaseFile=$SIGNED_APK" >> $GITHUB_OUTPUT
          echo "üì¶ Á≠æÂêçÂÆåÊàê: $SIGNED_APK"
          
          # 8. ÊòæÁ§∫ËØÅ‰π¶‰ø°ÊÅØ
          echo "üîê APKËØÅ‰π¶ÊåáÁ∫π:"
          $ANDROID_HOME/build-tools/34.0.0/apksigner verify --print-certs "$SIGNED_APK" | head -10

      # ÂêéÁª≠Ê≠•È™§‰øùÊåÅ‰∏çÂèòÔºå‰ΩÜË¶ÅÊõ¥Êñ∞ÂºïÁî®
      - name: Get History
        id: get_history
        run: |
          echo "# üöÄ Android APK ÂèëÂ∏É" > history.md
          echo "## ÁâàÊú¨: ${{ github.ref_name }}" >> history.md
          echo "## ÊûÑÂª∫Êó∂Èó¥: $(date)" >> history.md
          echo "## Á≠æÂêç‰ø°ÊÅØ" >> history.md
          echo "- ‚úÖ ‰ΩøÁî®Áªü‰∏ÄÂèëÂ∏ÉÂØÜÈí•" >> history.md
          echo "- ‚úÖ ÊîØÊåÅË¶ÜÁõñÂÆâË£Ö" >> history.md
          echo "- ‚úÖ Android 4.4+ ÂÖºÂÆπ" >> history.md

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
          body_path: history.md

      - name: Set Asset Name
        id: set_asset_name
        run: |
          VERSION_WITHOUT_V=$(echo '${{ github.ref_name }}' | sed 's/^v//')
          echo "asset_name=app_${VERSION_WITHOUT_V}_signed.apk" >> $GITHUB_ENV

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.sign_apk.outputs.signedReleaseFile }}
          asset_name: ${{ env.asset_name }}
          asset_content_type: application/vnd.android.package-archive
