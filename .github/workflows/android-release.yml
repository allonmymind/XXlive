name: Android Release (Manual Signing)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. è®¾ç½®ç¯å¢ƒ
    - name: Setup Java & Android
      uses: android-actions/setup-android@v3

    # 3. å½»åº•ç¦ç”¨Gradleè‡ªåŠ¨ç­¾å
    - name: Disable ALL Gradle signing
      run: |
        echo "ğŸ›‘ å½»åº•ç¦ç”¨Gradleè‡ªåŠ¨ç­¾å..."
        
        # åˆ é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„ç­¾åæ–‡ä»¶
        rm -f app/*.keystore app/*.jks
        rm -f app/build/outputs/apk/release/signingKey.jks
        
        # åˆ›å»ºå‡çš„ç­¾åé…ç½®ï¼Œç¡®ä¿Gradleä¸ç­¾å
        cat > gradle.properties << 'EOF'
# å¼ºåˆ¶ç¦ç”¨è‡ªåŠ¨ç­¾å
android.injected.signing.store.file=/dev/null
android.injected.signing.store.password=none
android.injected.signing.key.alias=none
android.injected.signing.key.password=none
# ç¦ç”¨Android Studioè‡ªåŠ¨ç­¾å
android.defaults.signing.enabled=false
EOF

    # 4. æ„å»ºå®Œå…¨æœªç­¾åçš„APK
    - name: Build UNSIGNED APK
      run: |
        chmod +x gradlew
        echo "ğŸ—ï¸ æ„å»ºå®Œå…¨æœªç­¾åçš„APK..."
        
        # ä½¿ç”¨è¿™äº›å‚æ•°ç¡®ä¿ä¸ç­¾å
        ./gradlew clean
        
        # å…³é”®ï¼šä½¿ç”¨assembleï¼Œä¸è¦ç”¨bundle
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=/dev/null \
          -Pandroid.injected.signing.store.password=none \
          -Pandroid.injected.signing.key.alias=none \
          -Pandroid.injected.signing.key.password=none
        
        echo "âœ… æ£€æŸ¥ç”Ÿæˆçš„APKæ–‡ä»¶ï¼š"
        find app/build/outputs/apk -name "*.apk" -type f | xargs ls -la

    # 5. æ‰‹åŠ¨ç­¾åï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
    - name: Manual APK Signing
      id: sign_apk
      env:
        KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE }}
      run: |
        echo "ğŸ” =========== å¼€å§‹æ‰‹åŠ¨ç­¾å ==========="
        
        # 1. è§£ç keystore
        echo "ğŸ“¥ è§£ç keystore..."
        echo "$KEYSTORE_BASE64" | base64 --decode > myapp.keystore
        
        # 2. éªŒè¯keystore
        echo "ğŸ” éªŒè¯keystore..."
        echo "æ–‡ä»¶ç±»å‹:"
        file myapp.keystore
        echo "æ–‡ä»¶å¤§å°: $(wc -c < myapp.keystore) bytes"
        
        # 3. æŸ¥æ‰¾æœªç­¾åçš„APK
        echo "ğŸ“¦ æŸ¥æ‰¾APKæ–‡ä»¶..."
        # ä¼˜å…ˆæ‰¾æœªç­¾åçš„ï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±æ‰¾releaseçš„
        UNSIGNED_APK=""
        if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          UNSIGNED_APK="app/build/outputs/apk/release/app-release-unsigned.apk"
        elif [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          UNSIGNED_APK="app/build/outputs/apk/release/app-release.apk"
        else
          # æŸ¥æ‰¾ä»»æ„release APK
          UNSIGNED_APK=$(find app/build/outputs/apk -name "*release*.apk" -type f | head -1)
        fi
        
        if [ -z "$UNSIGNED_APK" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°APKæ–‡ä»¶ï¼"
          find app/build/outputs/apk -type f | xargs ls -la
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ°APK: $UNSIGNED_APK"
        
        # 4. å¯¹é½APK
        echo "ğŸ“ å¯¹é½APK..."
        ALIGNED_APK="${UNSIGNED_APK%.apk}-aligned.apk"
        $ANDROID_HOME/build-tools/34.0.0/zipalign -v -p 4 "$UNSIGNED_APK" "$ALIGNED_APK"
        
        # 5. ç­¾åAPKï¼ˆå…³é”®ï¼šä½¿ç”¨JKSæ ¼å¼ï¼‰
        echo "ğŸ–Šï¸ ç­¾åAPK..."
        SIGNED_APK="app/build/outputs/apk/release/app-release-FINAL.apk"
        
        # ç›´æ¥å°è¯•ä½¿ç”¨ä½ çš„keystoreï¼Œå¦‚æœå¤±è´¥åˆ™è½¬æ¢æ ¼å¼
        $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
          --ks myapp.keystore \
          --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
          --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
          --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
          --v1-signing-enabled true \
          --v2-signing-enabled true \
          --out "$SIGNED_APK" \
          "$ALIGNED_APK" || {
            echo "âš ï¸ ç¬¬ä¸€æ¬¡ç­¾åå°è¯•å¤±è´¥ï¼Œå°è¯•è½¬æ¢æ ¼å¼..."
            # è½¬æ¢ä¸ºJKSæ ¼å¼
            keytool -importkeystore \
              -srckeystore myapp.keystore \
              -destkeystore myapp.jks \
              -deststoretype JKS \
              -srcstorepass "${{ secrets.KEYSTORE_PASSWORD }}" \
              -deststorepass "${{ secrets.KEYSTORE_PASSWORD }}" \
              -srcalias "${{ secrets.KEY_ALIAS }}" \
              -destalias "${{ secrets.KEY_ALIAS }}" \
              -noprompt
            
            # ä½¿ç”¨JKSæ ¼å¼é‡æ–°ç­¾å
            $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
              --ks myapp.jks \
              --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
              --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
              --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
              --v1-signing-enabled true \
              --v2-signing-enabled true \
              --out "$SIGNED_APK" \
              "$ALIGNED_APK"
          }
        
        # 6. éªŒè¯ç­¾å
        echo "âœ… éªŒè¯ç­¾å..."
        $ANDROID_HOME/build-tools/34.0.0/apksigner verify --verbose "$SIGNED_APK"
        
        # 7. è¾“å‡ºç»“æœ
        echo "signedReleaseFile=$SIGNED_APK" >> $GITHUB_OUTPUT
        echo "ğŸ‰ =========== ç­¾åæˆåŠŸï¼ ==========="
        
        # 8. æ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶
        echo "ğŸ“Š æœ€ç»ˆæ–‡ä»¶ï¼š"
        ls -la "$SIGNED_APK"
        echo "æ–‡ä»¶å¤§å°: $(wc -c < "$SIGNED_APK") bytes"

    # 6. åˆ›å»ºå‘å¸ƒ
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: "Release ${{ github.ref_name }}"
        body: |
          ğŸš€ **Android APK å‘å¸ƒ**
          
          **ç‰ˆæœ¬:** ${{ github.ref_name }}
          **æ„å»ºæ—¶é—´:** $(date)
          
          âœ… **æ”¯æŒè¦†ç›–å®‰è£…**ï¼ˆä½¿ç”¨ç»Ÿä¸€å¯†é’¥ï¼‰
          âœ… **Android 4.4+ å…¼å®¹**ï¼ˆåŒ…å«V1ç­¾åï¼‰
          âœ… **è¯ä¹¦æŒ‡çº¹ä¸€è‡´**ï¼ˆå¯å®‰å…¨æ›´æ–°ï¼‰
          
          ğŸ”§ **æŠ€æœ¯ä¿¡æ¯:**
          - ç­¾åæ–¹å¼: æ‰‹åŠ¨ç­¾å
          - å¯†é’¥ç±»å‹: JKS
          - ç­¾åç‰ˆæœ¬: V1 + V2
          - æœ€å°SDK: Android 4.4 (API 19)
          
          ğŸ“± **å®‰è£…è¯´æ˜:**
          1. ä¸‹è½½APKæ–‡ä»¶
          2. ç›´æ¥å®‰è£…å³å¯è¦†ç›–æ—§ç‰ˆæœ¬
          3. åº”ç”¨æ•°æ®å°†è‡ªåŠ¨ä¿ç•™
        files: ${{ steps.sign_apk.outputs.signedReleaseFile }}
        draft: false
        prerelease: false
