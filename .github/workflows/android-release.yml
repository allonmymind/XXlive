name: build-with-new-keystore

on:
  workflow_dispatch: 

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Run build with Gradle wrapper
        run: ./gradlew clean && ./gradlew assembleRelease

      # åˆ›å»ºæ–°çš„keystore
      - name: Create New Keystore
        id: create_keystore
        run: |
          echo "åˆ›å»ºæ–°çš„keystore..."
          
          # è®¾ç½®å¯†ç ï¼ˆæ‚¨å¯ä»¥ä¿®æ”¹è¿™äº›å€¼ï¼‰
          STORE_PASS="AndroidRelease123"
          KEY_PASS="AndroidRelease123"
          ALIAS_NAME="myapp"
          
          # ç”Ÿæˆkeystore
          keytool -genkeypair \
            -keystore new.keystore \
            -alias "$ALIAS_NAME" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass "$STORE_PASS" \
            -keypass "$KEY_PASS" \
            -dname "CN=MyApp, OU=Development, O=MyCompany, L=City, ST=State, C=CN" \
            -noprompt
          
          echo "keystoreåˆ›å»ºæˆåŠŸï¼"
          echo "store_pass=$STORE_PASS" >> $GITHUB_OUTPUT
          echo "key_pass=$KEY_PASS" >> $GITHUB_OUTPUT
          echo "alias_name=$ALIAS_NAME" >> $GITHUB_OUTPUT

      - name: Sign APK with New Keystore
        run: |
          echo "ä½¿ç”¨æ–°keystoreç­¾å..."
          
          # å¯¹é½APK
          $ANDROID_HOME/build-tools/34.0.0/zipalign -v -p 4 \
            app/build/outputs/apk/release/app-release-unsigned.apk \
            app/build/outputs/apk/release/app-release-aligned.apk
          
          # ç­¾åAPK
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks new.keystore \
            --ks-pass pass:"${{ steps.create_keystore.outputs.store_pass }}" \
            --key-pass pass:"${{ steps.create_keystore.outputs.key_pass }}" \
            --ks-key-alias "${{ steps.create_keystore.outputs.alias_name }}" \
            --out app/build/outputs/apk/release/app-release-signed.apk \
            app/build/outputs/apk/release/app-release-aligned.apk
          
          echo "ç­¾åå®Œæˆï¼"
          echo "å¯†ç ä¿¡æ¯ï¼ˆè¯·ä¿å­˜ï¼‰ï¼š"
          echo "å¯†é’¥åº“å¯†ç : ${{ steps.create_keystore.outputs.store_pass }}"
          echo "åˆ«åå¯†ç : ${{ steps.create_keystore.outputs.key_pass }}"
          echo "åˆ«å: ${{ steps.create_keystore.outputs.alias_name }}"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ğŸ” ä½¿ç”¨æ–°å¯†é’¥ç­¾åçš„ç‰ˆæœ¬
            
            ç‰ˆæœ¬: ${{ github.ref_name }}
            æ„å»ºæ—¶é—´: $(date)
            
            âš ï¸ æ³¨æ„ï¼š
            - æ­¤ç‰ˆæœ¬ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„å¯†é’¥ç­¾å
            - å¦‚éœ€å‡çº§åº”ç”¨ï¼Œéœ€ä½¿ç”¨ç›¸åŒå¯†é’¥ç­¾å
            - è¯·ä¿å­˜ä»¥ä¸‹å¯†é’¥ä¿¡æ¯ï¼š
              - åˆ«å: ${{ steps.create_keystore.outputs.alias_name }}
              - å¯†é’¥åº“å¯†ç : ${{ steps.create_keystore.outputs.store_pass }}
              - åˆ«åå¯†ç : ${{ steps.create_keystore.outputs.key_pass }}
          files: app/build/outputs/apk/release/app-release-signed.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
